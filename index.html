<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>PhysLabJs</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #F0F0F0;
        }
    </style>
<script src="https://cdn.rawgit.com/konvajs/konva/2.0.3/konva.min.js"></script>
</head>
<body>

<table>
  <tr>
    <td><button onclick="start()">Start</button>
    <td><button  onclick="stop()">Stop</button>
</table>
  <div id="container"></div>
<script>

var ELAST_COEFF = 0.75;

var animationOn = false;

var width = window.innerWidth;
var height = window.innerHeight-50;

var stage = new Konva.Stage({
    container: 'container',
    width: width,
    height: height
});

var layer = new Konva.Layer();
var rectX = 20; //stage.getWidth() / 2 - 50;
var rectY = 20; //stage.getHeight() / 2 - 25;

var grpbody1 = new Konva.Circle({
    x: rectX,
    y: rectY,
    radius: 10,
    fill: '#00D2FF',
    strokeWidth: 0,
    draggable: true
});

var grpbody2 = new Konva.Circle({
    x: rectX,
    y: rectY,
    radius: 10,
    fill: '#D200FF',
    strokeWidth: 0,
    draggable: true
});

var grpbody3 = new Konva.Circle({
    x: rectX,
    y: rectY,
    radius: 10,
    fill: '#D2FF00',
    strokeWidth: 0,
    draggable: true
});

var grpbodies = [grpbody1,grpbody2,grpbody3];

// add cursor styling
/*
grpbody.on('mouseover', function() {
    document.body.style.cursor = 'pointer';
});
grpbody.on('mouseout', function() {
    document.body.style.cursor = 'default';
});
*/



  function start()
  {
    if(!animationOn)
    {
      animationOn = true;
      anim.start();
    }
  }

  function stop()
  {
    animationOn=false;
    anim.stop();
  }



  function Body(ax,ay,dx,dy,grpobj)
  {
    this._ax=ax;
    this._ay=ay;
    this.ax=0;
    this.ay=0;
    this.dx=dx;
    this.dy=dy;
    this.grpobj = grpobj;

    this.getMass = function()
    {
      return this.grpobj.radius() *this.grpobj.radius();
    }


    this.getMomentum = function()
    {
      return this.getMass() * Math.sqrt(this.dx*this.dx + this.dy*this.dy);
    }

    this.move = function()
    {
      // Accelerazione
      this.dx += this.ax + this._ax;
      this.dy += this.ay + this._ay;

      var x = grpobj.x();
      var y = grpobj.y();
      var radius = this.grpobj.radius();

      var w = grpobj.getStage().getWidth();
      var h = grpobj.getStage().getHeight();

      debugger;
      // Rimbalzo
      if(x + this.dx > w - radius || x + this.dx < radius) {
          this.dx = - ELAST_COEFF * this.dx;
      }

      if(y + this.dy > h - radius || y + this.dy < radius) {
          this.dy = - ELAST_COEFF * this.dy;
      }

      // Spostamento
      x += this.dx;
      y += this.dy;

      grpobj.x(x);
      grpobj.y(y);
    }

    this.prepareForInteract = function()
    {
      this.ax=0;
      this.ay=0;
    }

  }



    function collisionManagement(objects)
    {
      for(var i=0;i<objects.length;i++)
        for(var j=0;j<objects.length;j++)
          if(i!=j && i>=j)
          {
            var o1 = objects[i];
            var o2 = objects[j];

            var x = o1.x-o2.x;
            var y = o1.y-o2.y;

            if(x*x+y*y< (o1.radius+o2.radius)*(o1.radius+o2.radius) )
            {
              // Collisione
              animationOn = false;

              var p1 = o1.getMomentum();
              var p2 = o2.getMomentum();

            }
          }
    }

    function interact(o1,o2)
    {

      var x = o1.x-o2.x;
      var y = o1.y-o2.y;

      // Angolo del vettore f
      var alpha = Math.atan(Math.abs(y/x));

      var f = 0.01 / Math.sqrt(x*x + y*y);

      // componenti di f lungo gli assi
      var fx1 = f * Math.cos(alpha) * o2.getMass();
      var fy1 = f * Math.sin(alpha) * o2.getMass();

      var fx2 = f * Math.cos(alpha) * o1.getMass();
      var fy2 = f * Math.sin(alpha) * o1.getMass();

      if(x>0) fx1 = - fx1; o1.ax += fx1;
      if(y>0) fy1 = - fy1; o1.ay += fy1;

      if(x<0) fx2= - fx2; o2.ax += fx2;
      if(y<0) fy2= - fy2; o2.ay += fy2;
    }


    for(var b=0;b<grpbodies.length;b++)
      layer.add(grpbodies[b]);
    stage.add(layer);

    var body1 = new Body(0,0.05,0.5,0,grpbody1);
    var body2 = new Body(0,0.05,1,0,grpbody2);
    var body3 = new Body(0,0.05,1.5,0,grpbody3);

    var bodies = [body1,body2,body3];

    var amplitude = 100;
    var period = 2000;
    // in ms
    var centerX = stage.getWidth() / 2;
    var anim = new Konva.Animation(function(frame) {
        if(animationOn)
        {
          for(var i=0;i<bodies.length;i++)
            bodies[i].move();
          //body.setX(amplitude * Math.sin(frame.time * 2 * Math.PI / period) + centerX);
        }
    }, layer);

    anim.start();
</script>

</body>
</html>
